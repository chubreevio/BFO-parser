x-jsonlog-driver: &jsonlog-driver
  logging:
    driver: "json-file"
    options:
      # max-size: 10m
      # max-file: "5"
      tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"

x-common: &common
  restart: unless-stopped
  stdin_open: true
  tty: true

x-build-app: &build-app
  image: pers-opros-api--app
  build:
    args:
      APP_ROOT: /app
      APP_CONTAINER_NAME: app
      # ENVIRONMENT: development
      APP_HOSTNAME: bfo-parser-api
    context: ./
    dockerfile: .docker/Dockerfiles/app.Dockerfile

x-backend: &backend
  <<: [*build-app, *common, *jsonlog-driver]
  working_dir: /app
  environment:
    TZ: Asia/Krasnoyarsk
  volumes:
    - ./:/app
    - ./.docker/user.conf/.gitconfig:/root/.gitconfig
  networks:
    - bfo-parser

services:
  bfo-parser-api--app:
    <<: *backend
    ulimits:
      core:
        hard: 0
        soft: 0
    container_name: bfo-parser-api--app
    # Основная команда: сначала тесты, потом приложение
    command: bash -c "uvicorn app.startup:app --host 0.0.0.0 --port 8000 --reload --proxy-headers --forwarded-allow-ips='*' --log-level debug"
    ports:
      - "8000:8000"
    depends_on:
      - bfo-parser-api--db
      - bfo-parser-api--db-test
    environment:
      - TZ=Asia/Krasnoyarsk
      # Переменные будут переопределены в команде
      - DATABASE_URL=postgresql://${DB_USERNAME}:${DB_PASSWORD}@bfo-parser-api--db:5432/${DB_DATABASE}
      - REDIS_URL=redis://bfo-parser-api--redis:6379

  bfo-parser-api--db:
    <<: *jsonlog-driver
    image: postgres:15.3-alpine
    container_name: bfo-parser-api--db
    environment:
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_DATABASE}
    ports:
      - "${DB_EXTERNAL_PORT}:5432"
    restart: always
    volumes:
      - ./.storages/postgresdata:/var/lib/postgresql/data
    healthcheck:
      test: >
        sh -c "
        pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}
        "
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - bfo-parser

  # Тестовая БД - запускается только на время тестов
  bfo-parser-api--db-test:
    <<: *jsonlog-driver
    image: postgres:15.3-alpine
    container_name: bfo-parser-api--db-test
    environment:
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_TEST_PASSWORD}
      - POSTGRES_DB=${DB_DATABASE}
    ports:
      - "${DB_TEST_EXTERNAL_PORT}:5432"
    restart: "no"  # Не перезапускаем автоматически
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - bfo-parser

  bfo-parser-api--redis:
    <<: *jsonlog-driver
    image: redis:7.2.10-alpine
    container_name: bfo-parser-api--redis
    command: --notify-keyspace-events Ex
    restart: always
    volumes:
      - ./.storages/redisdata:/data
    networks:
      - bfo-parser

volumes:
  dbdata:
  cache:
    driver: local

networks:
  bfo-parser: